rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // Usuários: só podem ler/escrever seus próprios dados
    match /users/{userId} {
      allow read, write: if request.auth != null && request.auth.uid == userId;
    }

    // Empresas: qualquer autenticado pode consultar
    match /empresas/{empresaId} {
      // Qualquer usuário autenticado pode criar uma empresa
      allow create: if request.auth != null;

      // Qualquer usuário autenticado pode consultar empresas (para verificar CNPJ)
      allow read: if request.auth != null;

      // Atualização permitida SE:
      // - O usuário já estiver no array de 'usuarios' OU 'administradores'
      // OU
      // - Estiver tentando se adicionar ao array 'usuarios'
      allow update: if request.auth != null &&
        (
          resource.data.usuarios.hasAny([request.auth.uid]) ||
          resource.data.administradores.hasAny([request.auth.uid]) ||
          isAddingSelfAsUsuario()
        );

      // Função para checar se está se adicionando ao array 'usuarios'
      function isAddingSelfAsUsuario() {
        return !resource.data.usuarios.hasAny([request.auth.uid]) &&
               request.resource.data.usuarios.hasAny([request.auth.uid]);
      }
    }
  }
}